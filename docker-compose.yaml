services:
  # --- Grant's Main Page ---
  grantSite:
    build:
      context: .
      dockerfile: ./bun-server/Dockerfile
    image: grantsite-prod # Explicit lowercase image name required
    container_name: grantSite
    restart: unless-stopped
    volumes:
      - ./Grant:/usr/app/public:ro # Mounts your site files into the container
    ports:
      - "${GRANT_SITE_PORT}:8080" # Exposes this site on port 8081 (or configured) of your Mac Mini

# --- Portainer --
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer-ce
    restart: unless-stopped
    ports:
      - "${PORTAINER_PORT}:9000" # Exposes Portainer's UI on port 9000 of your Mac Mini
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock # Gives Portainer access to manage Docker
      - portainer_data:/data # Persists Portainer's data

  # --- Uptime Kuma - Monitoring Dashboard ---
  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: uptime-kuma
    restart: unless-stopped
    ports:
      - "${UPTIME_KUMA_PORT}:3001" # Exposes Uptime Kuma on port 3001 of your Mac Mini
    volumes:
      - uptime_kuma_data:/app/data # Persists Uptime Kuma's data
      - /var/run/docker.sock:/var/run/docker.sock

  # --- PrivateBin - Secure Pastebin ---
  privatebin:
    image: privatebin/nginx-fpm-alpine:latest
    container_name: privatebin
    restart: unless-stopped
    ports:
      - "${PRIVATEBIN_PORT}:8080" # Exposes PrivateBin on port 8084 of your Mac Mini

# --- Cloudflare Tunnel Connector ---
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared-tunnel
    restart: unless-stopped
    command: tunnel --no-autoupdate run --token ${CLOUDFLARED_TUNNEL_TOKEN}
    # Note: A token is now the preferred method. You get the token from the 
    # Cloudflare Zero Trust dashboard when you select your tunnel.


# --- Add future websites below this line ---

# --- N8N Install

#  db:
#    image: postgres:14
#    environment:
#      - POSTGRES_USER=n8n
#      - POSTGRES_PASSWORD=
#      - POSTGRES_DB=n8n
#    volumes:
#      - postgres_data:/var/lib/postgresql/data

  n8n:
    image: n8nio/n8n
    container_name: n8n-automation
    ports:
      - "${N8N_PORT}:5678"
    environment:
#      - DB_TYPE=postgresdb
#      - DB_POSTGRESDB_HOST=db
#      - DB_POSTGRESDB_DATABASE=n8n
#      - DB_POSTGRESDB_USER=n8n
#      - DB_POSTGRESDB_PASSWORD=
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD}
      - N8N_HOST=${N8N_HOST}
      - WEBHOOK_TUNNEL_URL=${N8N_WEBHOOK_TUNNEL_URL}
      - TZ=${TZ}
    restart: unless-stopped
#    depends_on:
#      - db
    volumes:
      - ./n8n_data:/home/node/.n8n

volumes:
  portainer_data:
  uptime_kuma_data:
