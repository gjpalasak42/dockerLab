services:
  # --- Grant's Main Page ---
  grantSite:
    build:
      context: .
      dockerfile: ./bun-server/Dockerfile
    image: grantsite-prod # Explicit lowercase image name required
    container_name: grantSite
    restart: unless-stopped
    volumes:
      - ./Grant:/usr/app/public:ro # Mounts your site files into the container
    ports:
      - "127.0.0.1:${GRANT_SITE_PORT}:8080" # Bind to localhost only; expose via reverse proxy
    healthcheck:
      test: ["CMD", "bun", "-e", "fetch('http://localhost:8080/').then(r => process.exit(r.ok ? 0 : 1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # --- Portainer ---
  portainer:
    image: portainer/portainer-ce:2.21.5-alpine
    container_name: portainer-ce
    restart: unless-stopped
    ports:
      - "127.0.0.1:${PORTAINER_PORT}:9000" # Bind to localhost only
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro # Read-only where possible
      - portainer_data:/data # Persists Portainer's data
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # --- Uptime Kuma - Monitoring Dashboard ---
  uptime-kuma:
    image: louislam/uptime-kuma:1.23.16
    container_name: uptime-kuma
    restart: unless-stopped
    ports:
      - "127.0.0.1:${UPTIME_KUMA_PORT}:3001" # Bind to localhost only
    volumes:
      - uptime_kuma_data:/app/data # Persists Uptime Kuma's data
      - /var/run/docker.sock:/var/run/docker.sock:ro
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001', r => process.exit(r.statusCode < 400 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # --- PrivateBin - Secure Pastebin ---
  privatebin:
    image: privatebin/nginx-fpm-alpine:1.7.6
    container_name: privatebin
    restart: unless-stopped
    ports:
      - "127.0.0.1:${PRIVATEBIN_PORT}:8080" # Bind to localhost only
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # --- Cloudflare Tunnel Connector ---
  cloudflared:
    image: cloudflare/cloudflared:2024.12.2
    container_name: cloudflared-tunnel
    restart: unless-stopped
    command: tunnel --no-autoupdate run --token ${CLOUDFLARED_TUNNEL_TOKEN}
    # Note: A token is now the preferred method. You get the token from the
    # Cloudflare Zero Trust dashboard when you select your tunnel.
    healthcheck:
      test: ["CMD", "cloudflared", "tunnel", "info"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

# --- Add future websites below this line ---

# --- N8N Install

#  db:
#    image: postgres:14
#    environment:
#      - POSTGRES_USER=n8n
#      - POSTGRES_PASSWORD=
#      - POSTGRES_DB=n8n
#    volumes:
#      - postgres_data:/var/lib/postgresql/data

  n8n:
    image: n8nio/n8n:1.72.1
    container_name: n8n-automation
    ports:
      - "127.0.0.1:${N8N_PORT}:5678" # Bind to localhost only
    environment:
#      - DB_TYPE=postgresdb
#      - DB_POSTGRESDB_HOST=db
#      - DB_POSTGRESDB_DATABASE=n8n
#      - DB_POSTGRESDB_USER=n8n
#      - DB_POSTGRESDB_PASSWORD=
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD}
      - N8N_HOST=${N8N_HOST}
      - WEBHOOK_TUNNEL_URL=${N8N_WEBHOOK_TUNNEL_URL}
      - TZ=${TZ}
    restart: unless-stopped
#    depends_on:
#      - db
    volumes:
      - ./n8n_data:/home/node/.n8n
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  portainer_data:
  uptime_kuma_data:
